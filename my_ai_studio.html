<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My AI Studio — Gemini · Flow · OpenAI (Mode A)</title>
<style>
:root{
  --bg: #050507;
  --diamond: #0b0b0f;
  --gold: #d4af37;
  --muted: #9aa0a6;
  --card: #0f1113;
  --radius: 12px;
}
*{box-sizing:border-box;font-family: "Noto Sans Bengali", Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
body{margin:0;background:linear-gradient(180deg,var(--bg),#07101a);color:#eef2ff;min-height:100vh;padding:20px;display:flex;justify-content:center;}
.container{width:100%;max-width:1150px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);box-shadow:0 20px 60px rgba(0,0,0,0.6)}
.header{display:flex;gap:12px;align-items:center;padding:18px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-bottom:1px solid rgba(255,255,255,0.03)}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--diamond),#121217);display:flex;align-items:center;justify-content:center}
.logo strong{color:var(--gold)}
.header h1{margin:0;font-size:18px}
.header p{margin:0;color:var(--muted);font-size:13px}
.top-controls{margin-left:auto;display:flex;gap:8px;align-items:center}
.input{background:var(--card);border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:10px;color:#eef2ff}
.btn{background:linear-gradient(180deg,var(--gold),#b58f2d);color:#0b0b0b;padding:8px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--gold)}
.main{display:grid;grid-template-columns:360px 1fr;gap:18px;padding:18px}
.panel{padding:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
.section{margin-bottom:12px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
textarea,input[type="text"],select{width:100%;padding:10px;border-radius:8px;background:var(--diamond);border:1px solid rgba(255,255,255,0.03);color:#eef2ff;font-size:14px}
textarea{min-height:80px;resize:vertical}
.tabs{display:flex;gap:8px;margin-bottom:8px}
.tab{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--muted)}
.tab.active{background:linear-gradient(90deg, rgba(212,175,55,0.12), rgba(212,175,55,0.06));color:var(--gold);font-weight:700;border-color:rgba(212,175,55,0.12)}
.content{padding:12px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.02)}
.preview-img{max-width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,#0b0b0f,#111116);padding:8px}
.outputs{display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto}
.out-item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
.small{font-size:13px;color:var(--muted)}
.notice{padding:10px;border-radius:8px;background:rgba(255,215,0,0.06);color:var(--gold);border:1px solid rgba(212,175,55,0.08)}
.footer{padding:12px;border-top:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}
@media (max-width:1000px){.main{grid-template-columns:1fr}.grid{grid-template-columns:1fr}.top-controls{flex-direction:column;align-items:flex-end}}
</style>
</head>
<body>
<div class="container" role="application" aria-label="My AI Studio">
  <div class="header">
    <div class="logo"><strong>AI</strong></div>
    <div>
      <h1>My AI Studio</h1>
      <p>Google Gemini · Google Flow · OpenAI — Mode A (API keys enter in browser)</p>
    </div>

    <div class="top-controls" title="আপনি কিউই এখানে সেট করবেন (লোকালি)">
      <input id="googleKey" class="input" type="password" placeholder="Google API Key (পেস্ট here)" />
      <input id="openaiKey" class="input" type="password" placeholder="OpenAI API Key (পেস্ট here)" />
      <button id="saveKeysBtn" class="btn ghost">সেভ লোকালি</button>
      <button id="clearKeysBtn" class="btn ghost">ক্লিয়ার কী</button>
    </div>
  </div>

  <div class="main">
    <aside class="panel" aria-label="Control panel">
      <div class="section">
        <div class="tabs" role="tablist">
          <div class="tab active" data-tab="editor">ইমেজ এডিট</div>
          <div class="tab" data-tab="t2i">টেক্সট → ইমেজ</div>
          <div class="tab" data-tab="flow">ভিডিও ফ্লো</div>
          <div class="tab" data-tab="openai">OpenAI</div>
        </div>
      </div>

      <!-- Image Editor (Gemini Vision) -->
      <div id="editor" class="section tabpanel">
        <label>ইমেজ আপলোড (JPG/PNG)</label>
        <input id="imageFile" type="file" accept="image/*" />
        <div class="small" style="margin-top:6px">আপলোড করলে ইমেজটি বেইজ64-এ কনভার্ট হবে।</div>
        <label style="margin-top:8px">এডিট প্রম্পট (বাংলা/ইংরেজি)</label>
        <textarea id="editPrompt" placeholder="উদাহরণ: change background to tropical sunset, add warm tones"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="runEdit" class="btn">Gemini এডিট চালান</button>
          <button id="downloadEdit" class="btn ghost" disabled>ডাউনলোড</button>
        </div>
        <div style="margin-top:10px" class="small">বিঃদ্রঃ: Google Generative APIs কিছু ক্ষেত্রে ব্রাউজার-সিদ্ধ CORS ব্লক করতে পারে — যদি তাই হয়, আপনি একটি ছোট প্রোক্সি সার্ভার/ফাংশন ব্যবহার করতে পারেন। নিচে নির্দেশাবলী দেখুন।</div>
      </div>

      <!-- Text to Image (Imagen/Gemini) -->
      <div id="t2i" class="section tabpanel" style="display:none">
        <label>প্রম্পট (Text → Image)</label>
        <textarea id="t2iPrompt" placeholder="A cinematic portrait of a warrior at sunrise, 16:9"></textarea>
        <label style="margin-top:8px">আউটপুট সাইজ</label>
        <select id="t2iSize"><option value="16:9">16:9</option><option value="1:1">1:1</option><option value="9:16">9:16</option></select>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="runT2I" class="btn">Gemini/Imagen তৈরি করুন</button>
          <button id="downloadT2I" class="btn ghost" disabled>ডাউনলোড</button>
        </div>
      </div>

      <!-- Video Flow -->
      <div id="flow" class="section tabpanel" style="display:none">
        <label>ভিডিও ধারণা (ভিত্তি)</label>
        <textarea id="flowPrompt" placeholder="A drone shot slowly pans up from a foggy lake to reveal a glowing mountain castle"></textarea>
        <label style="margin-top:8px">এসপেক্ট</label>
        <select id="flowSize"><option value="16:9">16:9</option><option value="9:16">9:16</option></select>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="runFlow" class="btn">৪টি কিফ্রেম তৈরি করুন (Gemini → Imagen)</button>
        </div>
        <div style="margin-top:8px" class="small">নোট: এই টুলটি ভিডিও ফাইল তৈরির পরিবর্তে ৪টি কিফ্রেম (ইমেজ) তৈরি করে; পরবর্তীতে আপনি এগুলো ভিডিও আকারে কম্পোজ করতে পারবেন।</div>
      </div>

      <!-- OpenAI section -->
      <div id="openai" class="section tabpanel" style="display:none">
        <label>OpenAI Image Prompt (DALL·E)</label>
        <textarea id="openaiPrompt" placeholder="A fantasy landscape, vivid colors"></textarea>
        <label style="margin-top:8px">সাইজ</label>
        <select id="openaiSize"><option value="1024x1024">1024x1024</option><option value="512x512">512x512</option></select>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="runOpenAI" class="btn">OpenAI ইমেজ তৈরি</button>
          <button id="downloadOpenAI" class="btn ghost" disabled>ডাউনলোড</button>
        </div>
        <div style="margin-top:10px" class="small">নোট: OpenAI API কনসোল/ডকস অনুযায়ী আপনার key ব্যবহার করুন।</div>
      </div>

      <div style="margin-top:8px" class="section">
        <div class="notice"><strong>সতর্কতা:</strong> কিছু API সরাসরি ব্রাউজার থেকে কল করলে CORS সমস্যা হতে পারে — যদি কোনো কল ব্যর্থ হয়, আমি নীচে 'সার্ভার প্রোক্সি' সেটআপের ছোট নির্দেশ দেবো।</div>
      </div>

    </aside>

    <section class="content">
      <div class="grid">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800;color:var(--gold)">রিয়েল-টাইম প্রিভিউ</div>
              <div class="small" id="previewMeta">এখানে আউটপুট দেখা যাবে</div>
            </div>
            <div style="display:flex;gap:8px">
              <button id="clearPreview" class="btn ghost">ক্লিয়ার</button>
            </div>
          </div>

          <div style="margin-top:12px" id="previewArea" class="center">
            <img id="previewImage" class="preview-img" src="" alt="preview" style="display:none"/>
            <div id="previewEmpty" class="small">কোনো ইমেজ নেই</div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800;color:var(--gold)">আউটপুটস</div>
            <div class="small">ডাউনলোড / কপি ডাটা URL</div>
          </div>
          <div class="outputs" id="outputs"></div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <div style="font-weight:800">ডেভ অপশন ও নির্দেশ</div>
        <ol style="margin-top:8px" class="small">
          <li>Mode A অনুযায়ী Google এবং OpenAI কী টপ বারে পেস্ট করুন। কী লোকালি browser localStorage-এ সেভ হবে।</li>
          <li>কিছু API ব্রাউজার-সাইড কল ব্লক করলে (CORS) আপনাকে ছোট প্রোক্সি/ফাংশন ব্যবহার করতে হবে — আমি নীচে নির্দেশাবলী দেব।</li>
          <li>এই পেজে কোনো কী স্বয়ংক্রিয়ভাবে আদানপ্রদান হবে না; সব লোকালি থাকে।</li>
        </ol>
        <div style="margin-top:8px" class="small">
          <strong>সার্ভার প্রোক্সি প্রয়োজন হলে:</strong>
          <pre style="background:#0b0b0f;padding:8px;border-radius:6px;overflow:auto;border:1px solid rgba(255,255,255,0.02)">Use a tiny function (Node/Cloud Function) that forwards requests to Google/OpenAI and sets the API key server-side. This avoids CORS & hides keys.</pre>
        </div>
      </div>
    </section>
  </div>

  <div class="footer">
    <div>Made with ♥ — My AI Studio</div>
    <div class="small">আপনার কী লোকালি রাখা হয় — নিরাপদ।</div>
  </div>
</div>

<script>
// Utility helpers
function toBase64(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(',')[1]);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
}
function downloadDataUrl(dataUrl, filename='image.png'){
  const a=document.createElement('a');
  a.href=dataUrl;
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function addOutput(title, dataUrl, meta){
  const out=document.getElementById('outputs');
  const div=document.createElement('div');
  div.className='out-item';
  div.innerHTML=`<img src="${dataUrl}" width="140" style="border-radius:8px"/><div style="flex:1"><div style="font-weight:700;color:var(--gold)">${title}</div><div class="small">${meta||''}</div></div>
  <div style="display:flex;flex-direction:column;gap:6px">
    <button class="btn ghost" data-url="${dataUrl}">ডাউনলোড</button>
    <button class="btn ghost" data-url="${dataUrl}" data-copy>কপি URL</button>
  </div>`;
  out.prepend(div);
  div.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', ()=>{
      const url=b.getAttribute('data-url');
      if(b.hasAttribute('data-copy')) navigator.clipboard.writeText(url).then(()=>alert('Copied data URL'));
      else downloadDataUrl(url, (title.replace(/\s+/g,'_')||'image')+'.png');
    });
  });
}

// Keys & UI
const googleKeyEl = document.getElementById('googleKey');
const openaiKeyEl = document.getElementById('openaiKey');
const saveKeysBtn = document.getElementById('saveKeysBtn');
const clearKeysBtn = document.getElementById('clearKeysBtn');

function loadKeys(){
  const g = localStorage.getItem('MY_AI_GOOGLE_KEY')||'';
  const o = localStorage.getItem('MY_AI_OPENAI_KEY')||'';
  googleKeyEl.value = g;
  openaiKeyEl.value = o;
}
loadKeys();

saveKeysBtn.addEventListener('click', ()=>{
  localStorage.setItem('MY_AI_GOOGLE_KEY', googleKeyEl.value.trim());
  localStorage.setItem('MY_AI_OPENAI_KEY', openaiKeyEl.value.trim());
  alert('API কী লোকালি সেভ হয়েছে (localStorage)।');
});
clearKeysBtn.addEventListener('click', ()=>{
  localStorage.removeItem('MY_AI_GOOGLE_KEY');
  localStorage.removeItem('MY_AI_OPENAI_KEY');
  googleKeyEl.value=''; openaiKeyEl.value='';
  alert('কী ক্লিয়ার করা হলো।');
});

// Tabs
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=> {
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tabpanel').forEach(p=>p.style.display='none');
    t.classList.add('active');
    document.getElementById(t.dataset.tab).style.display='block';
  });
});

// Preview control
document.getElementById('clearPreview').addEventListener('click', ()=>{
  document.getElementById('previewImage').style.display='none';
  document.getElementById('previewImage').src='';
  document.getElementById('previewEmpty').style.display='block';
});

// File upload handling for edit
let currentImageBase64 = null;
document.getElementById('imageFile').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  currentImageBase64 = await toBase64(f);
  const img = document.getElementById('previewImage');
  img.src = 'data:'+f.type+';base64,'+currentImageBase64;
  img.style.display='block';
  document.getElementById('previewEmpty').style.display='none';
  document.getElementById('downloadEdit').disabled = false;
});

// =========================
// Google Gemini Image Edit
// =========================
async function callGoogleGeminiImageEdit(imageBase64, prompt){
  const key = document.getElementById('googleKey').value.trim() || localStorage.getItem('MY_AI_GOOGLE_KEY');
  if(!key) throw new Error('Google API key missing.');
  // Endpoint used here as an example — adjust model name to what's available in your account.
  const url = `/google/generate/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${encodeURIComponent(key)}`;
  const payload = {
    contents: [
      {
        role: "user",
        parts: [
          { text: `Edit this image using the instruction: ${prompt}. Return a single IMAGE in base64.` },
          { inlineData: { mimeType: "image/png", data: imageBase64 } }
        ]
      }
    ],
    generationConfig: { responseModalities: ["IMAGE"] }
  };
  const resp = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });
  if(!resp.ok){
    const txt = await resp.text();
    throw new Error(`Google Gemini Edit failed: ${resp.status} ${txt}`);
  }
  const j = await resp.json();
  // Expecting inlineData in response (this depends on exact API)
  const base64 = j?.candidates?.[0]?.content?.parts?.find(p=>p.inlineData)?.inlineData?.data;
  if(!base64) throw new Error('No image data returned from Gemini edit.');
  return 'data:image/png;base64,'+base64;
}

// =========================
// Google Imagen / Gemini Text->Image
// =========================
async function callGoogleImagen(prompt, aspect='16:9'){
  const key = document.getElementById('googleKey').value.trim() || localStorage.getItem('MY_AI_GOOGLE_KEY');
  if(!key) throw new Error('Google API key missing.');
  const url = `/google/generate/v1beta/models/imagen-4.0-generate-001:predict?key=${encodeURIComponent(key)}`;
  const payload = {
    instances: [{ prompt: `Cinematic high-resolution image, aspect ${aspect}. ${prompt}` }],
    parameters: { sampleCount: 1, aspectRatio: aspect, outputMimeType: "image/png" }
  };
  const resp = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if(!resp.ok){ const txt = await resp.text(); throw new Error(`Imagen failed: ${resp.status} ${txt}`); }
  const j = await resp.json();
  const data = j?.predictions?.[0]?.content?.[0]?.image?.imageBytes || j?.predictions?.[0]?.image?.imageBytes;
  // Fallbacks depending on API response structure
  const b64 = data || j?.predictions?.[0]?.content?.[0]?.parts?.find(p=>p.inlineData)?.inlineData?.data;
  if(!b64) throw new Error('No image returned from Imagen.');
  return 'data:image/png;base64,'+b64;
}

// =========================
// Google Gemini for Flow (generate JSON keyframes)
// =========================
async function callGoogleGeminiFlow(prompt, frames=4, aspect='16:9'){
  const key = document.getElementById('googleKey').value.trim() || localStorage.getItem('MY_AI_GOOGLE_KEY');
  if(!key) throw new Error('Google API key missing.');
  const url = `/google/generate/v1beta/models/gemini-2.5-preview:generateContent?key=${encodeURIComponent(key)}`;
  const requestPayload = {
    contents: [
      {
        role: "user",
        parts: [
          { text: `Break the following single video idea into exactly ${frames} cinematic sequential keyframes. Output MUST be a JSON array of objects with { "scene_title": "...", "prompt_en": "..." }.` },
          { text: `Video idea: ${prompt}. Aspect ratio: ${aspect}.` }
        ]
      }
    ],
    generationConfig: {
      responseMimeType: "application/json",
      responseSchema: {
        type: "ARRAY",
        items: { type: "OBJECT", properties: { scene_title: { type:"STRING" }, prompt_en: { type:"STRING" } } }
      }
    }
  };
  const resp = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(requestPayload) });
  if(!resp.ok){ const txt = await resp.text(); throw new Error(`Gemini Flow failed: ${resp.status} ${txt}`); }
  const j = await resp.json();
  const jsonText = j?.candidates?.[0]?.content?.parts?.[0]?.text;
  if(!jsonText) throw new Error('Gemini Flow did not return JSON text.');
  const scenes = JSON.parse(jsonText);
  return scenes;
}

// =========================
// OpenAI Image (DALL·E) call
// =========================
async function callOpenAIImage(prompt, size='1024x1024'){
  const key = document.getElementById('openaiKey').value.trim() || localStorage.getItem('MY_AI_OPENAI_KEY');
  if(!key) throw new Error('OpenAI API key missing.');
  const url = '/openai/generate/v1/images/generations';
  const payload = { prompt, n:1, size };
  const resp = await fetch(url, {
    method:'POST',
    headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer '+key },
    body: JSON.stringify(payload)
  });
  if(!resp.ok){ const txt = await resp.text(); throw new Error('OpenAI image failed: '+resp.status+' '+txt); }
  const j = await resp.json();
  const b64 = j?.data?.[0]?.b64_json || j?.data?.[0]?.url;
  if(!b64) throw new Error('No image in OpenAI response.');
  // If OpenAI returned a URL (older versions), return that directly; if base64, prefix.
  if(b64.startsWith('http')) return b64;
  return 'data:image/png;base64,'+b64;
}

// =========================
// UI Actions wiring
// =========================
document.getElementById('runEdit').addEventListener('click', async ()=>{
  try{
    if(!currentImageBase64){ alert('প্রথমে একটি ছবি আপলোড করুন।'); return; }
    const prompt = document.getElementById('editPrompt').value.trim();
    if(!prompt){ alert('সম্পাদনার নির্দেশ দিন।'); return; }
    const prevMeta = document.getElementById('previewMeta'); prevMeta.textContent = 'Gemini edit in progress...';
    const dataUrl = await callGoogleGeminiImageEdit(currentImageBase64, prompt);
    document.getElementById('previewImage').src = dataUrl; document.getElementById('previewImage').style.display='block'; document.getElementById('previewEmpty').style.display='none';
    addOutput('Gemini Edit', dataUrl, 'edited');
    document.getElementById('downloadEdit').disabled = false;
  }catch(err){
    alert('Error: '+err.message);
    console.error(err);
  } finally{
    document.getElementById('previewMeta').textContent = 'Ready';
  }
});

document.getElementById('runT2I').addEventListener('click', async ()=>{
  try{
    const prompt = document.getElementById('t2iPrompt').value.trim();
    if(!prompt){ alert('প্রম্পট লিখুন।'); return; }
    const aspect = document.getElementById('t2iSize').value;
    document.getElementById('previewMeta').textContent = 'Imagen generating...';
    const dataUrl = await callGoogleImagen(prompt, aspect);
    document.getElementById('previewImage').src = dataUrl; document.getElementById('previewImage').style.display='block'; document.getElementById('previewEmpty').style.display='none';
    addOutput('Gemini/Imagen', dataUrl, 't2i');
    document.getElementById('downloadT2I').disabled = false;
  }catch(err){
    alert('Error: '+err.message);
    console.error(err);
  } finally{ document.getElementById('previewMeta').textContent = 'Ready'; }
});

document.getElementById('runFlow').addEventListener('click', async ()=>{
  try{
    const prompt = document.getElementById('flowPrompt').value.trim();
    if(!prompt){ alert('প্রম্পট লিখুন।'); return; }
    const aspect = document.getElementById('flowSize').value;
    document.getElementById('previewMeta').textContent = 'Creating keyframes...';
    const scenes = await callGoogleGeminiFlow(prompt,4,aspect);
    // For each scene, call Imagen to generate image
    for(let i=0;i<scenes.length;i++){
      const s = scenes[i];
      const img = await callGoogleImagen(s.prompt_en || s.prompt, aspect);
      addOutput(s.scene_title || ('Scene '+(i+1)), img, 'flow frame');
    }
    alert('Flow frames generated and added to outputs.');
  }catch(err){
    alert('Error: '+err.message);
    console.error(err);
  } finally{ document.getElementById('previewMeta').textContent = 'Ready'; }
});

document.getElementById('runOpenAI').addEventListener('click', async ()=>{
  try{
    const prompt = document.getElementById('openaiPrompt').value.trim();
    if(!prompt){ alert('প্রম্পট লিখুন।'); return; }
    const size = document.getElementById('openaiSize').value;
    document.getElementById('previewMeta').textContent = 'OpenAI generating...';
    const dataUrl = await callOpenAIImage(prompt, size);
    // If returned HTTP URL, show as is; else data URL
    document.getElementById('previewImage').src = dataUrl; document.getElementById('previewImage').style.display='block'; document.getElementById('previewEmpty').style.display='none';
    addOutput('OpenAI Image', dataUrl, 'openai');
    document.getElementById('downloadOpenAI').disabled = false;
  }catch(err){
    alert('Error: '+err.message);
    console.error(err);
  } finally{ document.getElementById('previewMeta').textContent = 'Ready'; }
});

// Download buttons (for current last outputs)
document.getElementById('downloadEdit').addEventListener('click', ()=>{
  const img = document.getElementById('previewImage');
  if(img && img.src) downloadDataUrl(img.src,'edited_image.png');
});
document.getElementById('downloadT2I').addEventListener('click', ()=>{
  const img = document.getElementById('previewImage');
  if(img && img.src) downloadDataUrl(img.src,'t2i_image.png');
});
document.getElementById('downloadOpenAI').addEventListener('click', ()=>{
  const img = document.getElementById('previewImage');
  if(img && img.src) downloadDataUrl(img.src,'openai_image.png');
});

// On load: restore keys
window.addEventListener('DOMContentLoaded', ()=> loadKeys());

</script>
</body>
</html>
